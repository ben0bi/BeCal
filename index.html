<html>
<head>
	<title>BeCal + Ben0bis Calendar</title>
	<meta charset="utf-8" />
	<link rel="stylesheet" type="text/css" href="plugins/jdoor/jdoor.css" />
	<link rel="stylesheet" type="text/css" href="plugins/jdoor/jdoor_theme.css" />
	<link rel="stylesheet" type="text/css" href="plugins/anytime/anytime.5.2.0.css" />
	<link rel="stylesheet" type="text/css" href="plugins/spectrum/spectrum.css" />

	<link rel="stylesheet" type="text/css" href="css/BeCal.css" />
	<link rel="stylesheet" type="text/css" href="css/style.css" />	
</head>
<body>

<div id ="content"></div>
<div id="blocker"><div id="blockercontent">Bitte warten, ich arbeite..</div></div>

<script src="js/jquery-3.3.1.min.js"></script>
<script src="plugins/jdoor/jdoor.js"></script>
<script src="plugins/anytime/anytime.5.2.0.js"></script>
<script src="plugins/spectrum/spectrum.js"></script>
<script src="js/BeCal.js"></script>

<script>
/*
	Table structure:
		calendarevents
			id - BIGINT - primary key
			title - TEXT
			startdate - DATETIME
			enddate - DATETIME
			userid - BIGINT
			eventtype - INT
			summary - TEXT
			color - VARCHAR(10) - html #rrggbb
*/

// show and hide blocker functions.
function hideBlocker() {$('#blocker').hide();}
function showBlocker() {$('#blocker').show();}

// load events between two dates.
function loadEvents(calendar)
{
	showBlocker();
	var url = 'php/ajax_getdates.php';
	var data = null;
	var success = function(data)
	{
		console.log("event loading result:" +data);
		for(var i=0;i<data.length;i++)
		{
			var d = data[i];
			var startd = new Date(d.startdate);
			var endd = new Date(d.enddate);
			console.log(i+":"+d.title+" from "+d.startdate+" to "+d.enddate);
			console.log(" -> from "+startd+" to "+endd);
			calendar.createEvent(startd, endd, d.title, d.summary, d.color);
		}
		calendar.getToday();
		hideBlocker();
	}
	
	console.log("Loading events..");
	$.ajax({
		type: 'POST',
		url: url,
		data: data,
		success: success,
		dataType: 'json'
	});
	console.log("Endof Loading Events.");
}

function loadEvents2(calendar, startdate, enddate)
{
	showBlocker();
	
	// create SQL strings from the dates.
	var d1 = Date.toSQL(startdate);
	var d2 = Date.toSQL(enddate);
	
	var url = 'php/ajax_getdates.php';
	var data = {startdate: d1, enddate: d2};
	var success = function(data)
	{
		console.log("event loading result:" +data);
		for(var i=0;i<data.length;i++)
		{
			var d = data[i];
			var startd = new Date(d.startdate);
			var endd = new Date(d.enddate);
			console.log(i+":"+d.title+" from "+d.startdate+" to "+d.enddate);
			console.log(" -> from "+startd+" to "+endd);
			calendar.createEvent(startd, endd, d.title, d.summary, d.color);
		}
		calendar.getToday();
		hideBlocker();
	}
	
	console.log("Loading events..");
	$.ajax({
		type: 'POST',
		url: url,
		data: data,
		success: success,
		dataType: 'json'
	});
	console.log("Endof Loading Events.");
}

// resize the window.
$(window).resize(function(){BeCal.render();});
$(document).ready(function()
{
	// create the jdoor windows.
	$.fn.jdoor.defaults.WindowHideIconContent ="X";//"&#9776;";
	$.fn.jdoor.defaults.WindowTopBarHeight = 20;
	$.fn.jdoor.defaults.UseCookies = false; // we don't need the cookies.

	// create the calendar.
	var calendar = new BeCal('#content');
	//loadEvents(calendar);
	
	loadEvents2(calendar,new Date(), new Date());
});

</script>
</body>